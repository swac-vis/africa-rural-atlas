<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Africa Population Scatter Plot</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            overflow: hidden;
        }
        .container {
            width: 100vw;
            height: 100vh;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        h1 {
            text-align: center;
            color: #333;
            margin: 20px 0;
            font-size: 24px;
        }
        .chart-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .legend {
            margin: 20px 0;
            text-align: center;
        }
        .legend-item {
            display: inline-block;
            margin: 0 10px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid #ccc;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Africa Population Distribution Scatter Plot</h1>
        <div class="chart-container">
            <div id="chart"></div>
        </div>
        <div class="legend" id="legend"></div>
    </div>

    <script>
        // 获取容器尺寸
        const container = document.querySelector('.chart-container');
        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;
        
        // 设置画布尺寸 - 使用容器的90%以确保有边距
        const width = containerWidth * 0.9;
        const height = containerHeight * 0.9;
        const margin = { top: 60, right: 60, bottom: 80, left: 80 };

        // 创建SVG
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // 创建工具提示
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip");

        // 加载数据
        d3.json("aggregated_100km_africa.json").then(function(data) {
            // 提取网格数据
            const gridData = Object.values(data.grid_data);
            
            // 计算总人口并添加到数据中
            gridData.forEach(d => {
                d.total_population = d.rural_population + d.urban_population;
                d.longitude = d.geographic_location.longitude;
                d.latitude = d.geographic_location.latitude;
            });

            // 过滤掉总人口为0的数据点
            const validData = gridData.filter(d => d.total_population > 0);

            // 计算经纬度范围
            const longitudeExtent = d3.extent(validData, d => d.longitude);
            const latitudeExtent = d3.extent(validData, d => d.latitude);
            
            // 计算经纬度的跨度
            const longitudeRange = longitudeExtent[1] - longitudeExtent[0];
            const latitudeRange = latitudeExtent[1] - latitudeExtent[0];
            
            // 计算可用的绘图区域
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;
            
            // 计算比例尺，保持经纬度的实际比例
            const aspectRatio = longitudeRange / latitudeRange;
            const plotAspectRatio = plotWidth / plotHeight;
            
            let scaleX, scaleY;
            
            if (aspectRatio > plotAspectRatio) {
                // 经度跨度更大，以宽度为准
                scaleX = plotWidth / longitudeRange;
                scaleY = scaleX;
            } else {
                // 纬度跨度更大，以高度为准
                scaleY = plotHeight / latitudeRange;
                scaleX = scaleY;
            }
            
            // 计算居中偏移
            const centerX = (plotWidth - longitudeRange * scaleX) / 2;
            const centerY = (plotHeight - latitudeRange * scaleY) / 2;

            // 设置比例尺
            const xScale = d3.scaleLinear()
                .domain(longitudeExtent)
                .range([margin.left + centerX, margin.left + centerX + longitudeRange * scaleX]);

            const yScale = d3.scaleLinear()
                .domain(latitudeExtent)
                .range([margin.top + centerY + latitudeRange * scaleY, margin.top + centerY]);

            // 颜色比例尺
            const colorScale = d3.scaleSequential()
                .domain([0, d3.max(validData, d => d.total_population)])
                .interpolator(d3.interpolateViridis);

            // 矩形大小（固定大小）
            const rectSize = 6;

            // 绘制散点图 - 90度旋转
            svg.selectAll("rect")
                .data(validData)
                .enter()
                .append("rect")
                .attr("x", d => yScale(d.latitude) - rectSize/2)  // 纬度作为x坐标
                .attr("y", d => xScale(d.longitude) - rectSize/2)  // 经度作为y坐标
                .attr("width", rectSize)
                .attr("height", rectSize)
                .attr("fill", d => colorScale(d.total_population))
                .attr("stroke", "#fff")
                .attr("stroke-width", 0.5)
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`
                        <strong>Location:</strong> ${d.longitude.toFixed(2)}°, ${d.latitude.toFixed(2)}°<br>
                        <strong>Total Population:</strong> ${d.total_population.toLocaleString()}<br>
                        <strong>Rural Population:</strong> ${d.rural_population.toLocaleString()}<br>
                        <strong>Urban Population:</strong> ${d.urban_population.toLocaleString()}<br>
                        <strong>Rural Area:</strong> ${d.rural_area.toLocaleString()} km²<br>
                        <strong>Urban Area:</strong> ${d.urban_area.toLocaleString()} km²
                    `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // 添加坐标轴 - 90度旋转
            const xAxis = d3.axisBottom(yScale)  // 使用yScale作为x轴
                .tickFormat(d => d + "°")
                .ticks(6);

            const yAxis = d3.axisLeft(xScale)  // 使用xScale作为y轴
                .tickFormat(d => d + "°")
                .ticks(8);

            svg.append("g")
                .attr("transform", `translate(${margin.left},${height - margin.bottom})`)
                .call(xAxis);

            svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`)
                .call(yAxis);

            // 添加坐标轴标签
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height - 20)
                .style("text-anchor", "middle")
                .text("Latitude");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", 20)
                .style("text-anchor", "middle")
                .text("Longitude");

            // 创建图例
            const legendWidth = 400;
            const legendHeight = 20;
            const legendMargin = 20;

            const legendSvg = d3.select("#legend")
                .append("svg")
                .attr("width", legendWidth)
                .attr("height", legendHeight + 40);

            const legendScale = d3.scaleLinear()
                .domain([0, d3.max(validData, d => d.total_population)])
                .range([0, legendWidth - 2 * legendMargin]);

            const legendAxis = d3.axisBottom(legendScale)
                .ticks(5)
                .tickFormat(d => (d / 1000000).toFixed(1) + "M");

            const legendG = legendSvg.append("g")
                .attr("transform", `translate(${legendMargin}, 20)`);

            const legendGradient = legendG.append("defs")
                .append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", "0%")
                .attr("x2", "100%");

            legendGradient.selectAll("stop")
                .data(d3.ticks(0, 1, 10))
                .enter().append("stop")
                .attr("offset", d => d * 100 + "%")
                .attr("stop-color", d => d3.interpolateViridis(d));

            legendG.append("rect")
                .attr("width", legendWidth - 2 * legendMargin)
                .attr("height", legendHeight)
                .style("fill", "url(#legend-gradient)")
                .style("stroke", "#ccc");

            legendG.append("g")
                .attr("transform", `translate(0, ${legendHeight})`)
                .call(legendAxis);

            legendSvg.append("text")
                .attr("x", legendWidth / 2)
                .attr("y", legendHeight + 35)
                .style("text-anchor", "middle")
                .text("Total Population");

            // 添加标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", margin.top / 2)
                .style("text-anchor", "middle")
                .style("font-size", "18px")
                .style("font-weight", "bold")
                .text("Africa Population Distribution (100km Grid)");
        });
    </script>
</body>
</html> 