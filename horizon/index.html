<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Africa Rural-Urban Population Distribution by Distance to Roads</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .controls label {
            font-weight: 500;
            color: #333;
        }
        
        .controls input[type="range"] {
            width: 200px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2E86AB;
            cursor: pointer;
        }
        
        .controls input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2E86AB;
            cursor: pointer;
            border: none;
        }
        
        .country-row {
            cursor: pointer;
        }
        
        .country-label {
            font-size: 12px;
            fill: #333;
        }
        
        .axis-label {
            font-size: 12px;
            fill: #666;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .heatmap-cell {
            stroke: #fff;
            stroke-width: 0.5;
        }
        
        .legend-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            min-width: auto;
        }
        
        .legend-section h4 {
            margin: 0;
            color: #333;
            font-size: 12px;
            text-align: center;
            min-width: auto;
        }
        
        .opacity-legend {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .opacity-bar {
            width: 70px;
            height: 14px;
            border: 1px solid #ccc;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
        }
        
        .urban-bar {
            background: linear-gradient(to right, rgba(46, 134, 171, 0), rgba(46, 134, 171, 1));
        }
        
        .rural-bar {
            background: linear-gradient(to right, rgba(162, 59, 114, 0), rgba(162, 59, 114, 1));
        }
        
        .threshold-marker {
            position: absolute;
            top: -3px;
            width: 2px;
            height: 20px;
            background-color: #333;
            border-radius: 1px;
            cursor: ew-resize;
            z-index: 10;
        }
        
        .opacity-labels {
            display: flex;
            justify-content: space-between;
            width: 70px;
            font-size: 8px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Africa Rural-Urban Population Distribution</h1>
        <div class="subtitle">Population share by distance to nearest road (km)</div>
        
        <div class="controls">
            <div class="control-group">
                <label for="displayMode">Display Mode:</label>
                <select id="displayMode">
                    <option value="default">Default (Urban/Rural)</option>
                    <option value="urban">Urban Only</option>
                    <option value="rural">Rural Only</option>
                    <option value="all">All (Urban + Rural)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="distanceSlider">Maximum Distance: <span id="distanceValue">50</span>km</label>
                <input type="range" id="distanceSlider" min="1" max="100" value="50" step="1">
            </div>
            <div class="control-group">
                <label for="sortSelect">Sort by:</label>
                <select id="sortSelect">
                    <option value="population">Total Population</option>
                    <option value="urban">Urban Population</option>
                    <option value="rural">Rural Population</option>
                    <option value="name">Country Name</option>
                </select>
            </div>
            <div class="control-group">
                <div class="legend-section">
                    <h4>Urban</h4>
                    <div class="opacity-legend">
                        <div class="opacity-bar urban-bar" id="urbanOpacityBar">
                            <div class="threshold-marker" id="urbanThresholdMarker"></div>
                        </div>
                        <div class="opacity-labels">
                            <span>0%</span>
                            <span>50%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="legend-section">
                    <h4>Rural</h4>
                    <div class="opacity-legend">
                        <div class="opacity-bar rural-bar" id="ruralOpacityBar">
                            <div class="threshold-marker" id="ruralThresholdMarker"></div>
                        </div>
                        <div class="opacity-labels">
                            <span>0%</span>
                            <span>50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="chart"></div>
    </div>

    <script>
        // Global variables
        let data;
        let processedData;
        let svg;
        let xScale;
        let yScale;
        let maxDistance = 50;
        let urbanOpacityThreshold = 0;
        let ruralOpacityThreshold = 0;
        let displayMode = 'default';
        
        // Set up dimensions
        const margin = {top: 20, right: 30, bottom: 40, left: 200};
        const width = 1200 - margin.left - margin.right;
        const height = 1200 - margin.top - margin.bottom;
        
        // Create SVG
        svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip");
        
        // Load data
        d3.json("road_distance_country.json").then(function(loadedData) {
            data = loadedData;
            initializeChart();
            setupSlider();
        });
        
        function initializeChart() {
            // Process data for heatmap
            const countries = Object.keys(data).filter(d => d !== "all_countries");
            
            // Create processed data
            processedData = countries.map(country => {
                const countryData = data[country];
                const intervals = countryData.distance_intervals;
                
                // Create array of distance intervals up to maxDistance
                const distanceData = [];
                for (let i = 1; i <= maxDistance; i++) {
                    const intervalKey = i.toString();
                    const interval = intervals[intervalKey];
                    
                    if (interval) {
                        distanceData.push({
                            distance: i,
                            urban: interval.urban_share_of_total_population,
                            rural: interval.rural_share_of_total_population,
                            total: interval.urban_share_of_total_population + interval.rural_share_of_total_population
                        });
                    } else {
                        distanceData.push({
                            distance: i,
                            urban: 0,
                            rural: 0,
                            total: 0
                        });
                    }
                }
                
                return {
                    country: country,
                    data: distanceData,
                    totalPopulation: countryData.population
                };
            });
            
            // Sort countries based on selected option
            const sortBy = document.getElementById('sortSelect').value;
            switch(sortBy) {
                case 'population':
                    processedData.sort((a, b) => b.totalPopulation - a.totalPopulation);
                    break;
                case 'urban':
                    processedData.sort((a, b) => {
                        const aUrban = a.data.reduce((sum, d) => sum + d.urban, 0);
                        const bUrban = b.data.reduce((sum, d) => sum + d.urban, 0);
                        return bUrban - aUrban;
                    });
                    break;
                case 'rural':
                    processedData.sort((a, b) => {
                        const aRural = a.data.reduce((sum, d) => sum + d.rural, 0);
                        const bRural = b.data.reduce((sum, d) => sum + d.rural, 0);
                        return bRural - aRural;
                    });
                    break;
                case 'name':
                    processedData.sort((a, b) => a.country.localeCompare(b.country));
                    break;
                default:
                    processedData.sort((a, b) => b.totalPopulation - a.totalPopulation);
            }
            
            // Set up scales
            xScale = d3.scaleBand()
                .domain(d3.range(1, maxDistance + 1))
                .range([0, width])
                .padding(0.01);
            
            yScale = d3.scaleBand()
                .domain(processedData.map(d => d.country))
                .range([0, height])
                .padding(0.01);
            
            // Clear previous chart
            svg.selectAll("*").remove();
            
            // Create axes
            const xAxis = d3.axisBottom(xScale)
                .tickFormat(d => d)
                .ticks(Math.min(maxDistance, 20));
            
            const yAxis = d3.axisLeft(yScale);
            
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis)
                .selectAll("text")
                .style("font-size", "10px")
                .style("text-anchor", "middle");
            
            svg.append("g")
                .attr("class", "y-axis")
                .call(yAxis)
                .selectAll("text")
                .style("font-size", "11px")
                .style("font-weight", "500")
                .selectAll("line")
                .remove();
            
            // Add axis labels
            svg.append("text")
                .attr("class", "axis-label")
                .attr("x", width / 2)
                .attr("y", height + 35)
                .attr("text-anchor", "middle")
                .text("Distance to Nearest Road (km)");
            
            svg.append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -100)
                .attr("text-anchor", "middle")
                .text("Countries");
            
            // Create heatmap
            processedData.forEach((countryData, countryIndex) => {
                const countryGroup = svg.append("g")
                    .attr("class", "country-row")
                    .attr("transform", `translate(0,${yScale(countryData.country)})`);
                
                if (displayMode === 'default') {
                    // Create heatmap cells for urban population
                    countryGroup.selectAll("rect.urban")
                        .data(countryData.data)
                        .enter()
                        .append("rect")
                        .attr("class", "heatmap-cell urban")
                        .attr("x", d => xScale(d.distance))
                        .attr("y", 0)
                        .attr("width", xScale.bandwidth())
                        .attr("height", yScale.bandwidth() / 2)
                        .attr("fill", "#2E86AB")
                        .style("opacity", d => {
                            const opacity = Math.max(0, d.urban * 2);
                            return opacity >= urbanOpacityThreshold / 100 ? opacity : 0;
                        })
                        .on("mouseover", function(event, d) {
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event, d) {
                            tooltip.html(`
                                <strong>${countryData.country}</strong><br/>
                                Distance: ${d.distance-1}-${d.distance}km<br/>
                                Urban: ${(d.urban * 100).toFixed(1)}%<br/>
                                Rural: ${(d.rural * 100).toFixed(1)}%<br/>
                                Total: ${(d.total * 100).toFixed(1)}%
                            `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.style("opacity", 0);
                        });
                    
                    // Create heatmap cells for rural population
                    countryGroup.selectAll("rect.rural")
                        .data(countryData.data)
                        .enter()
                        .append("rect")
                        .attr("class", "heatmap-cell rural")
                        .attr("x", d => xScale(d.distance))
                        .attr("y", yScale.bandwidth() / 2)
                        .attr("width", xScale.bandwidth())
                        .attr("height", yScale.bandwidth() / 2)
                        .attr("fill", "#A23B72")
                        .style("opacity", d => {
                            const opacity = Math.max(0, d.rural * 2);
                            return opacity >= ruralOpacityThreshold / 100 ? opacity : 0;
                        })
                        .on("mouseover", function(event, d) {
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event, d) {
                            tooltip.html(`
                                <strong>${countryData.country}</strong><br/>
                                Distance: ${d.distance-1}-${d.distance}km<br/>
                                Urban: ${(d.urban * 100).toFixed(1)}%<br/>
                                Rural: ${(d.rural * 100).toFixed(1)}%<br/>
                                Total: ${(d.total * 100).toFixed(1)}%
                            `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.style("opacity", 0);
                        });
                } else if (displayMode === 'urban') {
                    // Create heatmap cells for urban population only (full height)
                    countryGroup.selectAll("rect.urban")
                        .data(countryData.data)
                        .enter()
                        .append("rect")
                        .attr("class", "heatmap-cell urban")
                        .attr("x", d => xScale(d.distance))
                        .attr("y", 0)
                        .attr("width", xScale.bandwidth())
                        .attr("height", yScale.bandwidth())
                        .attr("fill", "#2E86AB")
                        .style("opacity", d => {
                            const opacity = Math.max(0, d.urban * 2);
                            return opacity >= urbanOpacityThreshold / 100 ? opacity : 0;
                        })
                        .on("mouseover", function(event, d) {
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event, d) {
                            tooltip.html(`
                                <strong>${countryData.country}</strong><br/>
                                Distance: ${d.distance-1}-${d.distance}km<br/>
                                Urban: ${(d.urban * 100).toFixed(1)}%<br/>
                                Rural: ${(d.rural * 100).toFixed(1)}%<br/>
                                Total: ${(d.total * 100).toFixed(1)}%
                            `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.style("opacity", 0);
                        });
                } else if (displayMode === 'rural') {
                    // Create heatmap cells for rural population only (full height)
                    countryGroup.selectAll("rect.rural")
                        .data(countryData.data)
                        .enter()
                        .append("rect")
                        .attr("class", "heatmap-cell rural")
                        .attr("x", d => xScale(d.distance))
                        .attr("y", 0)
                        .attr("width", xScale.bandwidth())
                        .attr("height", yScale.bandwidth())
                        .attr("fill", "#A23B72")
                        .style("opacity", d => {
                            const opacity = Math.max(0, d.rural * 2);
                            return opacity >= ruralOpacityThreshold / 100 ? opacity : 0;
                        })
                        .on("mouseover", function(event, d) {
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event, d) {
                            tooltip.html(`
                                <strong>${countryData.country}</strong><br/>
                                Distance: ${d.distance-1}-${d.distance}km<br/>
                                Urban: ${(d.urban * 100).toFixed(1)}%<br/>
                                Rural: ${(d.rural * 100).toFixed(1)}%<br/>
                                Total: ${(d.total * 100).toFixed(1)}%
                            `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.style("opacity", 0);
                        });
                } else if (displayMode === 'all') {
                    // Create heatmap cells for combined population (full height)
                    countryGroup.selectAll("rect.combined")
                        .data(countryData.data)
                        .enter()
                        .append("rect")
                        .attr("class", "heatmap-cell combined")
                        .attr("x", d => xScale(d.distance))
                        .attr("y", 0)
                        .attr("width", xScale.bandwidth())
                        .attr("height", yScale.bandwidth())
                        .attr("fill", d => {
                            // Use a blend color or gradient for combined view
                            const urbanRatio = d.urban / (d.urban + d.rural);
                            const ruralRatio = d.rural / (d.urban + d.rural);
                            if (d.urban + d.rural === 0) return "#f0f0f0";
                            
                            // Blend urban and rural colors based on their proportions
                            const urbanColor = d3.rgb("#2E86AB");
                            const ruralColor = d3.rgb("#A23B72");
                            const blendedColor = d3.rgb(
                                urbanColor.r * urbanRatio + ruralColor.r * ruralRatio,
                                urbanColor.g * urbanRatio + ruralColor.g * ruralRatio,
                                urbanColor.b * urbanRatio + ruralColor.b * ruralRatio
                            );
                            return blendedColor.toString();
                        })
                        .style("opacity", d => {
                            const totalOpacity = Math.max(0, (d.urban + d.rural) * 2);
                            return totalOpacity >= Math.max(urbanOpacityThreshold, ruralOpacityThreshold) / 100 ? totalOpacity : 0;
                        })
                        .on("mouseover", function(event, d) {
                            tooltip.style("opacity", 1);
                        })
                        .on("mousemove", function(event, d) {
                            tooltip.html(`
                                <strong>${countryData.country}</strong><br/>
                                Distance: ${d.distance-1}-${d.distance}km<br/>
                                Urban: ${(d.urban * 100).toFixed(1)}%<br/>
                                Rural: ${(d.rural * 100).toFixed(1)}%<br/>
                                Total: ${(d.total * 100).toFixed(1)}%
                            `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.style("opacity", 0);
                        });
                }
            });
        }
        
        function setupSlider() {
            const slider = document.getElementById('distanceSlider');
            const valueDisplay = document.getElementById('distanceValue');
            const sortSelect = document.getElementById('sortSelect');
            const displayModeSelect = document.getElementById('displayMode');
            
            slider.addEventListener('input', function() {
                maxDistance = parseInt(this.value);
                valueDisplay.textContent = maxDistance;
                initializeChart();
            });
            
            sortSelect.addEventListener('change', function() {
                initializeChart();
            });
            
            displayModeSelect.addEventListener('change', function() {
                displayMode = this.value;
                initializeChart();
            });
            
            // Setup interactive opacity bars
            setupOpacityBar('urbanOpacityBar', 'urbanThresholdMarker', 'urban');
            setupOpacityBar('ruralOpacityBar', 'ruralThresholdMarker', 'rural');
        }
        
        function setupOpacityBar(barId, markerId, type) {
            const bar = document.getElementById(barId);
            const marker = document.getElementById(markerId);
            
            // Set initial position
            updateMarkerPosition(marker, 0, bar.offsetWidth);
            
            let isDragging = false;
            
            // Click to set threshold
            bar.addEventListener('click', function(e) {
                const rect = bar.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = Math.min(100, Math.max(0, (clickX / rect.width) * 100));
                
                if (type === 'urban') {
                    urbanOpacityThreshold = percentage;
                } else {
                    ruralOpacityThreshold = percentage;
                }
                
                updateMarkerPosition(marker, percentage, bar.offsetWidth);
                updateOpacityFilter();
            });
            
            // Drag marker
            marker.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.stopPropagation();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const rect = bar.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const percentage = Math.min(100, Math.max(0, (mouseX / rect.width) * 100));
                    
                    if (type === 'urban') {
                        urbanOpacityThreshold = percentage;
                    } else {
                        ruralOpacityThreshold = percentage;
                    }
                    
                    updateMarkerPosition(marker, percentage, bar.offsetWidth);
                    updateOpacityFilter();
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }
        
        function updateMarkerPosition(marker, percentage, barWidth) {
            const position = (percentage / 100) * barWidth;
            marker.style.left = position + 'px';
        }
        
        function updateOpacityFilter() {
            if (displayMode === 'default') {
                // Update opacity for existing cells without redrawing the entire chart
                svg.selectAll("rect.urban")
                    .style("opacity", function(d) {
                        const opacity = Math.max(0, d.urban * 2);
                        return opacity >= urbanOpacityThreshold / 100 ? opacity : 0;
                    });
                
                svg.selectAll("rect.rural")
                    .style("opacity", function(d) {
                        const opacity = Math.max(0, d.rural * 2);
                        return opacity >= ruralOpacityThreshold / 100 ? opacity : 0;
                    });
            } else if (displayMode === 'urban') {
                svg.selectAll("rect.urban")
                    .style("opacity", function(d) {
                        const opacity = Math.max(0, d.urban * 2);
                        return opacity >= urbanOpacityThreshold / 100 ? opacity : 0;
                    });
            } else if (displayMode === 'rural') {
                svg.selectAll("rect.rural")
                    .style("opacity", function(d) {
                        const opacity = Math.max(0, d.rural * 2);
                        return opacity >= ruralOpacityThreshold / 100 ? opacity : 0;
                    });
            } else if (displayMode === 'all') {
                svg.selectAll("rect.combined")
                    .style("opacity", function(d) {
                        const totalOpacity = Math.max(0, (d.urban + d.rural) * 2);
                        return totalOpacity >= Math.max(urbanOpacityThreshold, ruralOpacityThreshold) / 100 ? totalOpacity : 0;
                    });
            }
        }
    </script>
</body>
</html> 