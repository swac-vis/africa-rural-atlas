<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Africa Population Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard {
            display: flex;
            height: 100vh;
            gap: 2px;
            background: #e9ecef;
        }

        .left-panel {
            width: 35%;
            background: #e9ecef;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .center-panel {
            width: 35%;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .right-panel {
            width: 30%;
            background: white;
            border: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
        }

        .chart-container {
            background: white;
            border: 1px solid #ddd;
            margin-bottom: 2px;
            position: relative;
        }

        .chart-header {
            padding: 15px 20px 10px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .chart-subtitle {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .chart-content {
            padding: 20px;
            height: 300px;
            overflow: hidden;
        }

        .chart-content.small {
            height: 200px;
        }

        .chart-content.medium {
            height: 250px;
        }

        .chart-content.large {
            height: 350px;
        }

        .toggle-buttons-container {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toggle-buttons {
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            padding: 4px 8px;
            border: 1px solid #bdc3c7;
            background: white;
            cursor: pointer;
            font-size: 10px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .stats-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stat-label {
            color: #7f8c8d;
        }

        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .country-list {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .country-item {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .country-item:hover {
            background: #f8f9fa;
            border-left-color: #3498db;
        }

        .country-item.selected {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .country-item.region-highlighted {
            background: #fff3e0;
            border-left-color: #ff9800;
            font-weight: 600;
        }

        .country-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .country-stats {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
        }


        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .axis-label {
            font-size: 12px;
            fill: #7f8c8d;
        }

        .axis-tick {
            font-size: 10px;
            fill: #7f8c8d;
        }

        .grid-line {
            stroke: #ecf0f1;
            stroke-width: 1;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="left-panel">
            <!-- 饼图 -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Africa Overall Population Distribution</div>
                    <div class="chart-subtitle">Urban vs Rural Population</div>
                    <div class="toggle-buttons">
                        <button class="toggle-btn active" data-type="percentage">%</button>
                        <button class="toggle-btn" data-type="numbers">#</button>
                    </div>
                </div>
                <div class="chart-content small">
                    <svg id="pie-chart" width="100%" height="100%"></svg>
                </div>
            </div>

            <!-- 区域图表 -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Population by Region</div>
                    <div class="chart-subtitle">Urban vs Rural by African Region</div>
                    <div class="toggle-buttons">
                        <button class="toggle-btn active" data-type="percentage">%</button>
                        <button class="toggle-btn" data-type="numbers">#</button>
                    </div>
                </div>
                <div class="chart-content medium">
                    <svg id="regions-chart" width="100%" height="100%"></svg>
                </div>
            </div>

            <!-- 国家图表 -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">All Countries Population Distribution</div>
                    <div class="chart-subtitle">Urban vs Rural by Country</div>
                    <div class="toggle-buttons">
                        <button class="toggle-btn active" data-type="percentage">%</button>
                        <button class="toggle-btn" data-type="numbers">#</button>
                    </div>
                </div>
                <div class="chart-content large">
                    <svg id="stacked-chart" width="100%" height="100%"></svg>
                </div>
            </div>

            <!-- 盒须图 -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Population Ratio Distribution by Region</div>
                    <div class="chart-subtitle">Box plot showing population distribution across African regions</div>
                    <div class="toggle-buttons-container">
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" data-type="boxplot">Box Plot</button>
                            <button class="toggle-btn" data-type="violin">Violin Plot</button>
                        </div>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" data-population-type="urban">Urban</button>
                            <button class="toggle-btn" data-population-type="rural">Rural</button>
                        </div>
                    </div>
                </div>
                <div class="chart-content large">
                    <svg id="distribution-chart" width="100%" height="100%"></svg>
                </div>
            </div>

            <!-- 密度图 -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Population Density Analysis</div>
                    <div class="chart-subtitle">Urban vs Rural Density by Country</div>
                </div>
                <div class="chart-content medium">
                    <svg id="density-chart" width="100%" height="100%"></svg>
                </div>
            </div>

            <!-- 城市化率图表 -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Population Distribution</div>
                    <div class="chart-subtitle">Population Ratio across African countries</div>
                    <div class="toggle-buttons">
                        <button class="toggle-btn active" data-type="percentage">%</button>
                        <button class="toggle-btn" data-type="numbers">#</button>
                    </div>
                </div>
                <div class="chart-content large">
                    <svg id="urbanization-chart" width="100%" height="100%"></svg>
                </div>
            </div>
        </div>

        <div class="center-panel">
            <!-- 地图 -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Country Map with Population Distribution</div>
                    <div class="chart-subtitle">Pie charts showing urban vs rural population by country</div>
                    <div class="toggle-buttons">
                        <button class="toggle-btn active" data-type="percentage">%</button>
                        <button class="toggle-btn" data-type="numbers">#</button>
                    </div>
                </div>
                <div class="chart-content" style="height: calc(100vh - 80px); flex: 1;">
                    <svg id="country-map" width="100%" height="100%"></svg>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="stats-summary" id="overall-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Countries:</span>
                    <span class="stat-value" id="total-countries">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Population:</span>
                    <span class="stat-value" id="total-population">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Urban Population:</span>
                    <span class="stat-value" id="urban-population">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Rural Population:</span>
                    <span class="stat-value" id="rural-population">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Urban Population Ratio:</span>
                    <span class="stat-value" id="urbanization-rate">-</span>
                </div>
            </div>

            <div class="country-list" id="country-list">
                <!-- 国家列表将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // 全局变量
        let populationData = null;
        let selectedCountry = null;
        let currentViewType = 'percentage'; // 'percentage' or 'numbers'
        let selectedRegions = new Set();
        let highlightedRegion = null; // 当前高亮的区域
        let currentPopulationType = 'urban'; // 'urban' or 'rural' for distribution chart

        // 简化的容器尺寸获取函数
        function getContainerSize(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return { width: 300, height: 200 };
            
            const rect = container.getBoundingClientRect();
            const padding = 20; // 容器内边距
            
            return {
                width: Math.max(rect.width - padding * 2, 200),
                height: Math.max(rect.height - padding * 2, 150)
            };
        }

        // 非洲区域映射
        const regionMapping = {
            'North Africa': ['Morocco', 'Algeria', 'Tunisia', 'Libya', 'Egypt', 'Mauritius'],
            'West Africa': ['Senegal', 'Gambia', 'Guinea-Bissau', 'Guinea', 'Sierra Leone', 
                            'Liberia', 'Côte d\'’Ivoire', 'Ghana', 'Togo', 'Benin', 'Nigeria', 
                            'Niger', 'Burkina Faso', 'Mali', 'Mauritania', 'Cabo Verde'],
            'Central Africa': ['Chad', 'Central African Republic', 'Cameroon', 'Gabon', 
                            'Congo', 'Democratic Republic of the Congo', 'Equatorial Guinea', 
                            'Sao Tome and Principe', 'Burundi'],
            'East Africa': ['Ethiopia', 'Eritrea', 'Djibouti', 'Somalia', 'Kenya', 
                            'Uganda', 'Tanzania', 'Rwanda', 'South Sudan', 'Sudan'],
            'Southern Africa': ['South Africa', 'Namibia', 'Botswana', 'Zimbabwe', 
                            'Zambia', 'Malawi', 'Mozambique', 'Angola', 'Lesotho', 
                            'Madagascar', 'Comoros', 'Swaziland', 'Seychelles']
        };

        // 颜色方案 - 更新为新的配色
        const colors = {
            urban: '#589FBC',
            rural: '#B4628E',
            regions: ['#589FBC', '#B4628E', '#95a5a6', '#7f8c8d', '#34495e', '#2c3e50', '#8e44ad'],
            density: '#589FBC',
            map: '#589FBC',
            mapBackground: '#f8f9fa',
            highlight: '#e74c3c',
            selected: '#2196f3',
            regionHighlight: '#ff9800'
        };

        // 加载数据
        async function loadData() {
            try {
                const response = await fetch('results/all_countries_population_data.json');
                populationData = await response.json();
                initializeDashboard();
            } catch (error) {
                // 如果无法加载JSON文件，使用内嵌数据
                loadEmbeddedData();
            }
        }

        // 内嵌数据（如果无法加载外部文件）
        function loadEmbeddedData() {
            // 这里可以放置一些示例数据
        }

        // 初始化仪表板
        function initializeDashboard() {
            updateOverallStats();
            createOverallPieChart();
            createCountriesStackedChart();
            createRegionsStackedChart();
            createDensityChart();
            createCountryMap();
            createUrbanizationChart();
            createDistributionChart();
            createCountryList();
            setupEventListeners();
        }

        // 更新总体统计
        function updateOverallStats() {
            const countries = Object.values(populationData.countries);
            const totalPopulation = countries.reduce((sum, country) => sum + country.total, 0);
            const urbanPopulation = countries.reduce((sum, country) => sum + country.urban, 0);
            const ruralPopulation = countries.reduce((sum, country) => sum + country.rural, 0);
            const urbanizationRate = Math.round(urbanPopulation / totalPopulation * 100);

            document.getElementById('total-countries').textContent = countries.length;
            document.getElementById('total-population').textContent = formatNumber(totalPopulation);
            document.getElementById('urban-population').textContent = formatNumber(urbanPopulation);
            document.getElementById('rural-population').textContent = formatNumber(ruralPopulation);
            document.getElementById('urbanization-rate').textContent = urbanizationRate + '%';
        }

        // 创建整体饼图
        function createOverallPieChart() {
            const container = d3.select('#pie-chart');
            
            // 如果图表已存在，只更新标签
            if (!container.select('g').empty()) {
                updatePieChartLabels();
                return;
            }

            // 初始化图表
            container.selectAll('*').remove();

            const countries = Object.values(populationData.countries);
            const totalUrban = countries.reduce((sum, country) => sum + country.urban, 0);
            const totalRural = countries.reduce((sum, country) => sum + country.rural, 0);

            const { width, height } = getContainerSize('pie-chart');
            const radius = Math.min(width, height) / 2 - 20;

            const svg = container
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${width/2}, ${height/2})`);

            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const data = [
                { label: 'Urban', value: totalUrban, color: colors.urban },
                { label: 'Rural', value: totalRural, color: colors.rural }
            ];

            const arcs = g.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => d.data.color)
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            // 添加标签
            arcs.append('text')
                .attr('class', 'pie-label')
                .attr('transform', d => `translate(${arc.centroid(d)})`)
                .attr('text-anchor', 'middle')
                .attr('font-size', Math.max(10, radius / 8) + 'px')
                .attr('font-weight', '600')
                .attr('fill', 'white')
                .text(d => {
                    if (currentViewType === 'percentage') {
                        const percentage = Math.round(d.data.value / (totalUrban + totalRural) * 100);
                        return `${percentage}%`;
                    } else {
                        return formatNumber(d.data.value);
                    }
                });

            // 添加图例
            const legend = svg.append('g')
                .attr('transform', `translate(${width - 100}, 20)`);

            data.forEach((d, i) => {
                const legendItem = legend.append('g')
                    .attr('transform', `translate(0, ${i * 20})`);

                legendItem.append('rect')
                    .attr('width', 12)
                    .attr('height', 12)
                    .attr('fill', d.color);

                legendItem.append('text')
                    .attr('x', 16)
                    .attr('y', 9)
                    .attr('font-size', '11px')
                    .text(d.label);
            });

        }

        // 更新饼图标签
        function updatePieChartLabels() {
            const countries = Object.values(populationData.countries);
            const totalUrban = countries.reduce((sum, country) => sum + country.urban, 0);
            const totalRural = countries.reduce((sum, country) => sum + country.rural, 0);

            d3.selectAll('.pie-label')
                .transition()
                .duration(300)
                .text(d => {
                    if (currentViewType === 'percentage') {
                        const percentage = Math.round(d.data.value / (totalUrban + totalRural) * 100);
                        return `${percentage}%`;
                    } else {
                        return formatNumber(d.data.value);
                    }
                });
        }


        // 创建国家堆叠图
        function createCountriesStackedChart() {
            const container = d3.select('#stacked-chart');
            
            // 如果图表已存在，只更新数据，不重新计算尺寸
            if (!container.select('g').empty()) {
                updateCountriesStackedChart();
                return;
            }

            // 初始化图表
            container.selectAll('*').remove();

            const countries = Object.values(populationData.countries)
                .sort((a, b) => b.total - a.total);

            const { width, height } = getContainerSize('stacked-chart');
            const margin = { top: 20, right: 20, bottom: 50, left: 60 };

            const svg = container
                .attr('width', width)
                .attr('height', height);

            const xScale = d3.scaleBand()
                .domain(countries.map(d => d.country))
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const maxValue = currentViewType === 'percentage' ? 100 : d3.max(countries, d => d.total);
            const yScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([height - margin.bottom, margin.top]);

            // 创建堆叠数据
            const stack = d3.stack()
                .keys(['urban', 'rural'])
                .value((d, key) => {
                    if (currentViewType === 'percentage') {
                        return (d[key] / d.total) * 100;
                    } else {
                        return d[key];
                    }
                });

            const stackedData = stack(countries);

            // 绘制堆叠条
            const groups = svg.selectAll('.country-group')
                .data(stackedData)
                .enter()
                .append('g')
                .attr('class', 'country-group')
                .attr('fill', d => d.key === 'urban' ? colors.urban : colors.rural);

            groups.selectAll('rect')
                .data(d => d)
                .enter()
                .append('rect')
                .attr('x', d => xScale(d.data.country))
                .attr('y', d => yScale(d[1]))
                .attr('width', xScale.bandwidth())
                .attr('height', d => yScale(d[0]) - yScale(d[1]))
                .attr('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    showTooltip(event, d.data, d.key);
                })
                .on('mouseout', hideTooltip)
                .on('click', function(event, d) {
                    selectCountry(d.data.country);
                });

            // 添加X轴
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .attr('text-anchor', 'end')
                .attr('font-size', '8px');

            // 添加Y轴
            svg.append('g')
                .attr('class', 'y-axis')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).tickFormat(d => {
                    if (currentViewType === 'percentage') {
                        return Math.round(d / maxValue * 100) + '%';
                    } else {
                        return formatNumber(d);
                    }
                }))
                .selectAll('text')
                .attr('font-size', '10px');

            // 添加Y轴标签
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 15)
                .attr('x', -height/2)
                .text(currentViewType === 'percentage' ? 'Percentage' : 'Population');
        }

        // 更新国家堆叠图数据
        function updateCountriesStackedChart() {
            const countries = Object.values(populationData.countries)
                .sort((a, b) => b.total - a.total);

            const container = d3.select('#stacked-chart');
            const width = +container.attr('width');
            const height = +container.attr('height');
            const margin = { top: 20, right: 20, bottom: 50, left: 60 };

            const xScale = d3.scaleBand()
                .domain(countries.map(d => d.country))
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const maxValue = currentViewType === 'percentage' ? 100 : d3.max(countries, d => d.total);
            const yScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([height - margin.bottom, margin.top]);

            // 创建堆叠数据
            const stack = d3.stack()
                .keys(['urban', 'rural'])
                .value((d, key) => {
                    if (currentViewType === 'percentage') {
                        return (d[key] / d.total) * 100;
                    } else {
                        return d[key];
                    }
                });

            const stackedData = stack(countries);

            // 更新堆叠条
            const groups = container.selectAll('.country-group')
                .data(stackedData);

            groups.selectAll('rect')
                .data(d => d)
                .transition()
                .duration(300)
                .attr('y', d => yScale(d[1]))
                .attr('height', d => yScale(d[0]) - yScale(d[1]));

            // 更新Y轴
            container.select('.y-axis')
                .transition()
                .duration(300)
                .call(d3.axisLeft(yScale).tickFormat(d => {
                    if (currentViewType === 'percentage') {
                        return Math.round(d / maxValue * 100) + '%';
                    } else {
                        return formatNumber(d);
                    }
                }));

            // 更新Y轴标签
            container.select('.axis-label')
                .text(currentViewType === 'percentage' ? 'Percentage' : 'Population');
        }


        // 创建区域堆叠图
        function createRegionsStackedChart() {
            const container = d3.select('#regions-chart');
            
            // 如果图表已存在，只更新数据
            if (!container.select('g').empty()) {
                updateRegionsStackedChart();
                return;
            }

            // 初始化图表
            container.selectAll('*').remove();

            // 计算区域数据
            const regionData = {};
            const missingCountries = [];
            
            Object.entries(regionMapping).forEach(([region, countries]) => {
                regionData[region] = {
                    region: region,
                    urban: 0,
                    rural: 0,
                    total: 0
                };
                
                countries.forEach(countryName => {
                    const country = populationData.countries[countryName];
                    if (country) {
                        regionData[region].urban += country.urban;
                        regionData[region].rural += country.rural;
                        regionData[region].total += country.total;
                    } else {
                        missingCountries.push(`${countryName} (${region})`);
                    }
                });
            });
            
            // 打印缺失的国家
            if (missingCountries.length > 0) {
                console.log('Missing countries in population data:', missingCountries);
            }

            const regions = Object.values(regionData).filter(d => d.total > 0);

            const { width, height } = getContainerSize('regions-chart');
            const margin = { top: 10, right: 20, bottom: 50, left: 60 };

            const svg = container
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .style('display', 'block')
                .style('width', '100%')
                .style('height', '100%')
                .style('max-width', '100%')
                .style('max-height', '100%');

            const xScale = d3.scaleBand()
                .domain(regions.map(d => d.region))
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const maxValue = currentViewType === 'percentage' ? 100 : d3.max(regions, d => d.total);
            const yScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([height - margin.bottom, margin.top]);

            // 创建堆叠数据
            const stack = d3.stack()
                .keys(['urban', 'rural'])
                .value((d, key) => {
                    if (currentViewType === 'percentage') {
                        return (d[key] / d.total) * 100;
                    } else {
                        return d[key];
                    }
                });

            const stackedData = stack(regions);

            // 绘制堆叠条
            const groups = svg.selectAll('.region-group')
                .data(stackedData)
                .enter()
                .append('g')
                .attr('class', 'region-group')
                .attr('fill', d => d.key === 'urban' ? colors.urban : colors.rural);

            groups.selectAll('rect')
                .data(d => d)
                .enter()
                .append('rect')
                .attr('x', d => xScale(d.data.region))
                .attr('y', d => yScale(d[1]))
                .attr('width', xScale.bandwidth())
                .attr('height', d => yScale(d[0]) - yScale(d[1]))
                .attr('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    showTooltip(event, d.data, d.key);
                })
                .on('mouseout', hideTooltip)
                .on('click', function(event, d) {
                    toggleRegionHighlight(d.data.region);
                })

            // 添加X轴
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .attr('text-anchor', 'end')
                .attr('font-size', '10px');

            // 添加Y轴
            svg.append('g')
                .attr('class', 'y-axis')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).tickFormat(d => {
                    if (currentViewType === 'percentage') {
                        return Math.round(d / maxValue * 100) + '%';
                    } else {
                        return formatNumber(d);
                    }
                }))
                .selectAll('text')
                .attr('font-size', '10px');

        }

        // 更新区域堆叠图数据
        function updateRegionsStackedChart() {
            // 计算区域数据
            const regionData = {};
            Object.entries(regionMapping).forEach(([region, countries]) => {
                regionData[region] = {
                    region: region,
                    urban: 0,
                    rural: 0,
                    total: 0
                };
                
                countries.forEach(countryName => {
                    const country = populationData.countries[countryName];
                    if (country) {
                        regionData[region].urban += country.urban;
                        regionData[region].rural += country.rural;
                        regionData[region].total += country.total;
                    }
                });
            });

            const regions = Object.values(regionData).filter(d => d.total > 0);
            const container = d3.select('#regions-chart');
            const width = +container.attr('width');
            const height = +container.attr('height');
            const margin = { top: 10, right: 20, bottom: 50, left: 60 };

            const xScale = d3.scaleBand()
                .domain(regions.map(d => d.region))
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const maxValue = currentViewType === 'percentage' ? 100 : d3.max(regions, d => d.total);
            const yScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([height - margin.bottom, margin.top]);

            // 创建堆叠数据
            const stack = d3.stack()
                .keys(['urban', 'rural'])
                .value((d, key) => {
                    if (currentViewType === 'percentage') {
                        return (d[key] / d.total) * 100;
                    } else {
                        return d[key];
                    }
                });

            const stackedData = stack(regions);

            // 更新堆叠条
            const groups = container.selectAll('.region-group')
                .data(stackedData);

            groups.selectAll('rect')
                .data(d => d)
                .transition()
                .duration(300)
                .attr('y', d => yScale(d[1]))
                .attr('height', d => yScale(d[0]) - yScale(d[1]));

            // 更新X轴
            container.select('g:last-child')
                .transition()
                .duration(300)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .attr('text-anchor', 'end')
                .attr('font-size', '10px');

            // 更新Y轴
            container.select('.y-axis')
                .transition()
                .duration(300)
                .call(d3.axisLeft(yScale).tickFormat(d => {
                    if (currentViewType === 'percentage') {
                        return Math.round(d / maxValue * 100) + '%';
                    } else {
                        return formatNumber(d);
                    }
                }));
        }


        // 创建密度图
        function createDensityChart() {
            const container = d3.select('#density-chart');
            
            // 如果图表已存在，只更新数据
            if (!container.select('g').empty()) {
                updateDensityChart();
                return;
            }

            // 初始化图表
            container.selectAll('*').remove();

            const countries = Object.values(populationData.countries)
                .filter(d => d.total > 0)
                .map(d => ({
                    ...d,
                    urbanDensity: d.urban / d.area_km2,
                    ruralDensity: d.rural / d.area_km2,
                    urbanShare: d.urban / d.total,
                    ruralShare: d.rural / d.total
                }));

            const { width, height } = getContainerSize('density-chart');
            const margin = { top: 20, right: 20, bottom: 40, left: 50 };

            const svg = container
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .style('display', 'block')
                .style('width', '100%')
                .style('height', '100%')
                .style('max-width', '100%')
                .style('max-height', '100%');

            // 使用百分比数据
            const xData = countries.map(d => d.urbanShare * 100);
            const yData = countries.map(d => d.ruralShare * 100);

            const xScale = d3.scaleLinear()
                .domain([0, 100])
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);

            // 绘制散点
            svg.selectAll('.point')
                .data(countries)
                .enter()
                .append('circle')
                .attr('class', 'point')
                .attr('cx', d => xScale(d.urbanShare * 100))
                .attr('cy', d => yScale(d.ruralShare * 100))
                .attr('r', d => Math.sqrt(d.total) / 10000)
                .attr('fill', colors.density)
                .attr('opacity', 0.6)
                .attr('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    showTooltip(event, d, 'density');
                })
                .on('mouseout', hideTooltip)
                .on('click', function(event, d) {
                    selectCountry(d.country);
                });

            // 添加X轴
            svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).tickFormat(d => d + '%'))
                .selectAll('text')
                .attr('font-size', '10px');

            // 添加Y轴
            svg.append('g')
                .attr('class', 'y-axis')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'))
                .selectAll('text')
                .attr('font-size', '10px');

            // 添加轴标签
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('x', width/2)
                .attr('y', height - 5)
                .attr('text-anchor', 'middle')
                .text('Urban Share (%)');

            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height/2)
                .attr('y', 15)
                .text('Rural Share (%)');
        }

        // 更新密度图数据
        function updateDensityChart() {
            const countries = Object.values(populationData.countries)
                .filter(d => d.total > 0)
                .map(d => ({
                    ...d,
                    urbanDensity: d.urban / d.area_km2,
                    ruralDensity: d.rural / d.area_km2,
                    urbanShare: d.urban / d.total,
                    ruralShare: d.rural / d.total
                }));

            const container = d3.select('#density-chart');
            const width = +container.attr('width');
            const height = +container.attr('height');
            const margin = { top: 20, right: 20, bottom: 30, left: 50 };

            // 使用百分比数据
            const xData = countries.map(d => d.urbanShare * 100);
            const yData = countries.map(d => d.ruralShare * 100);

            const xScale = d3.scaleLinear()
                .domain([0, 100])
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);

            // 更新散点
            container.selectAll('.point')
                .data(countries)
                .transition()
                .duration(300)
                .attr('cx', d => xScale(d.urbanShare * 100))
                .attr('cy', d => yScale(d.ruralShare * 100));

            // 更新X轴
            container.select('.x-axis')
                .transition()
                .duration(300)
                .call(d3.axisBottom(xScale).tickFormat(d => d + '%'));

            // 更新Y轴
            container.select('.y-axis')
                .transition()
                .duration(300)
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));

            // 更新轴标签
            container.selectAll('.axis-label')
                .transition()
                .duration(300)
                .text((d, i) => {
                    if (i === 0) {
                        return 'Urban Share (%)';
                    } else {
                        return 'Rural Share (%)';
                    }
                });
        }

        // 创建国家地图
        function createCountryMap() {
            const container = d3.select('#country-map');
            
            // 如果图表已存在，只更新数据
            if (!container.select('g').empty()) {
                updateCountryMap();
                return;
            }

            // 初始化图表
            container.selectAll('*').remove();

            // 检查数据是否已加载
            if (!populationData) {
                return;
            }

            const { width, height } = getContainerSize('country-map');
            const margin = { top: 10, right: 10, bottom: 30, left: 10 };

            const svg = container
                .attr('width', width)
                .attr('height', height)
                .style('display', 'block')
                .style('max-width', '100%')
                .style('height', 'auto');

            // 创建缩放行为
            const zoom = d3.zoom()
                .scaleExtent([0.5, 8])
                .on('zoom', function(event) {
                    mapGroup.attr('transform', event.transform);
                });

            svg.call(zoom);

            // 创建地图组
            const mapGroup = svg.append('g')
                .attr('class', 'map-group');

            // 计算最佳投影参数
            const projection = d3.geoMercator()
                .center([20, 0])
                .scale(1)
                .translate([0, 0]);

            const path = d3.geoPath().projection(projection);

            // 加载地理数据
            d3.json('results/africa.geojson').then(function(geoData) {
                
                // 计算边界框
                const bounds = path.bounds(geoData);
                const dx = bounds[1][0] - bounds[0][0];
                const dy = bounds[1][1] - bounds[0][1];
                const x = (bounds[0][0] + bounds[1][0]) / 2;
                const y = (bounds[0][1] + bounds[1][1]) / 2;
                
                // 使用更大的缩放比例，让地图充分利用容器空间
                const availableWidth = width - margin.left - margin.right;
                const availableHeight = height - margin.top - margin.bottom;
                const scale = Math.min(availableWidth / dx, availableHeight / dy) * 0.95;
                const translate = [width / 2 - scale * x, height / 2 - scale * y];

                // 更新投影
                projection
                    .scale(scale)
                    .translate(translate);

                // 创建人口颜色比例尺
                const countries = Object.values(populationData.countries);
                const maxPopulation = d3.max(countries, d => d.total);
                const minPopulation = d3.min(countries, d => d.total);
                
                const colorScale = d3.scaleSequential()
                    .domain([minPopulation, maxPopulation])
                    .interpolator(d3.interpolateBlues);

                // 绘制地图背景
                mapGroup.append('g')
                    .selectAll('path')
                    .data(geoData.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('fill', d => {
                        const countryName = d.properties.name;
                        const countryData = populationData.countries[countryName];
                        return countryData ? colorScale(countryData.total) : '#f0f0f0';
                    })
                    .attr('stroke', '#999')
                    .attr('stroke-width', 0.5)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        const countryName = d.properties.name;
                        const countryData = populationData.countries[countryName];
                        if (countryData) {
                            showTooltip(event, {
                                country: countryName,
                                ...countryData,
                                type: 'Total'
                            }, 'map');
                        }
                    })
                    .on('mouseout', hideTooltip)
                    .on('click', function(event, d) {
                        const countryName = d.properties.name;
                        const countryData = populationData.countries[countryName];
                        if (countryData) {
                            selectCountry(countryName);
                        }
                    });

                // 创建饼图生成器
                const pie = d3.pie()
                    .value(d => d.value)
                    .sort(null);

                const arc = d3.arc()
                    .innerRadius(0)
                    .outerRadius(d => Math.sqrt(d.data.value) / 1000 + Math.min(width, height) / 60);

                // 为每个国家添加饼图
                const countryPies = mapGroup.append('g')
                    .selectAll('.country-pie')
                    .data(geoData.features)
                    .enter()
                    .filter(d => {
                        const countryName = d.properties.name;
                        const hasData = populationData.countries[countryName];
                        return hasData;
                    })
                    .append('g')
                    .attr('class', 'country-pie');

                countryPies.each(function(d) {
                    const countryName = d.properties.name;
                    const countryData = populationData.countries[countryName];
                    const centroid = path.centroid(d);
                    
                    const pieData = [
                        { label: 'Urban', value: countryData.urban, color: colors.urban },
                        { label: 'Rural', value: countryData.rural, color: colors.rural }
                    ];

                    d3.select(this)
                        .attr('transform', `translate(${centroid[0]}, ${centroid[1]})`);

                    const arcs = d3.select(this)
                        .selectAll('.arc')
                        .data(pie(pieData))
                        .enter()
                        .append('g')
                        .attr('class', 'arc');

                    arcs.append('path')
                        .attr('d', arc)
                        .attr('fill', d => d.data.color)
                        .attr('stroke', 'white')
                        .attr('stroke-width', 0.5)
                        .attr('opacity', 0.7)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            showTooltip(event, {
                                country: countryName,
                                ...countryData,
                                type: d.data.label
                            }, 'map');
                        })
                        .on('mouseout', hideTooltip)
                        .on('click', function() {
                            selectCountry(countryName);
                        });
                });

                // 添加颜色图例
                const legendWidth = 200;
                const legendHeight = 20;
                const legendX = width - legendWidth - 20;
                const legendY = 20;

                const legend = svg.append('g')
                    .attr('class', 'population-legend')
                    .attr('transform', `translate(${legendX}, ${legendY})`);

                // 创建渐变定义
                const defs = svg.append('defs');
                const gradient = defs.append('linearGradient')
                    .attr('id', 'population-gradient')
                    .attr('x1', '0%')
                    .attr('x2', '100%')
                    .attr('y1', '0%')
                    .attr('y2', '0%');

                gradient.selectAll('stop')
                    .data(d3.range(0, 1.1, 0.1))
                    .enter()
                    .append('stop')
                    .attr('offset', d => d)
                    .attr('stop-color', d => colorScale(d3.interpolate(minPopulation, maxPopulation)(d)));

                // 绘制渐变条
                legend.append('rect')
                    .attr('width', legendWidth)
                    .attr('height', legendHeight)
                    .attr('fill', 'url(#population-gradient)');

                // 添加标签
                legend.append('text')
                    .attr('x', 0)
                    .attr('y', -5)
                    .attr('font-size', '12px')
                    .attr('font-weight', '600')
                    .text('Population Size');

                // 添加数值标签
                legend.append('text')
                    .attr('x', 0)
                    .attr('y', legendHeight + 15)
                    .attr('font-size', '10px')
                    .text(formatNumber(minPopulation));

                legend.append('text')
                    .attr('x', legendWidth)
                    .attr('y', legendHeight + 15)
                    .attr('text-anchor', 'end')
                    .attr('font-size', '10px')
                    .text(formatNumber(maxPopulation));


            }).catch(function(error) {
                // 如果无法加载地图数据，显示错误信息
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '14px')
                    .attr('fill', '#666')
                    .text('Map data not available');
            });
        }

        // 更新地图数据
        function updateCountryMap() {
            // 地图的饼图数据会根据currentViewType自动更新
            // 这里不需要额外的更新逻辑
        }

        // 创建城市化率分布图
        function createUrbanizationChart() {
            const container = d3.select('#urbanization-chart');
            
            // 如果图表已存在，只更新数据
            if (!container.select('g').empty()) {
                updateUrbanizationChart();
                return;
            }

            // 初始化图表
            container.selectAll('*').remove();

            const countries = Object.values(populationData.countries)
                .filter(d => d.total > 0)
                .map(d => ({
                    ...d,
                    urbanizationRate: d.urban_share * 100
                }))
                .sort((a, b) => b.urbanizationRate - a.urbanizationRate);
                // 显示所有国家

            const { width, height } = getContainerSize('urbanization-chart');
            const margin = { top: 20, right: 20, bottom: 50, left: 60 };

            const svg = container
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .style('display', 'block')
                .style('width', '100%')
                .style('height', '100%')
                .style('max-width', '100%')
                .style('max-height', '100%');

            // 创建比例尺
            const xScale = d3.scaleBand()
                .domain(countries.map(d => d.country))
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);

            // 创建颜色比例尺
            const colorScale = d3.scaleSequential()
                .domain([0, 100])
                .interpolator(d3.interpolate(colors.rural, colors.urban));

            // 绘制柱状图
            svg.selectAll('.urbanization-bar')
                .data(countries)
                .enter()
                .append('rect')
                .attr('class', 'urbanization-bar')
                .attr('x', d => xScale(d.country))
                .attr('y', d => yScale(d.urbanizationRate))
                .attr('width', xScale.bandwidth())
                .attr('height', d => height - margin.bottom - yScale(d.urbanizationRate))
                .attr('fill', d => colorScale(d.urbanizationRate))
                .attr('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    showTooltip(event, d, 'urbanization');
                })
                .on('mouseout', hideTooltip)
                .on('click', function(event, d) {
                    selectCountry(d.country);
                });

            // 添加X轴
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .attr('text-anchor', 'end')
                .attr('font-size', '8px');

            // 添加Y轴
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'))
                .selectAll('text')
                .attr('font-size', '10px');

            // 添加Y轴标签
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 15)
                .attr('x', -height/2)
                .text('Urban Population Ratio (%)');

            // 添加平均线
            const avgUrbanization = countries.reduce((sum, d) => sum + d.urbanizationRate, 0) / countries.length;
            svg.append('line')
                .attr('x1', margin.left)
                .attr('x2', width - margin.right)
                .attr('y1', yScale(avgUrbanization))
                .attr('y2', yScale(avgUrbanization))
                .attr('stroke', colors.highlight)
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5');

            // 添加平均线标签
            svg.append('text')
                .attr('x', width - margin.right - 5)
                .attr('y', yScale(avgUrbanization) - 5)
                .attr('text-anchor', 'end')
                .attr('font-size', '10px')
                .attr('fill', colors.highlight)
                .text(`Avg: ${avgUrbanization.toFixed(1)}%`);
        }

        // 更新城市化率图表数据
        function updateUrbanizationChart() {
            // 城市化率图表数据不依赖于视图类型，所以不需要更新
            // 这个函数只是为了保持一致性
        }

        // 创建分布图表（盒须图/小提琴图）
        function createDistributionChart() {
            const container = d3.select('#distribution-chart');
            
            // 清除现有图表
            container.selectAll('*').remove();

            // 初始化图表
            container.selectAll('*').remove();

            // 准备数据 - 按区域分组人口比例
            const regionData = {};
            Object.entries(regionMapping).forEach(([region, countries]) => {
                regionData[region] = countries
                    .map(countryName => populationData.countries[countryName])
                    .filter(country => country && country.total > 0)
                    .map(country => ({
                        country: country.country,
                        populationRatio: currentPopulationType === 'urban' ? 
                            country.urban_share * 100 : 
                            country.rural_share * 100,
                        region: region
                    }));
            });

            const regions = Object.keys(regionData).filter(region => regionData[region].length > 0);
            const allData = regions.flatMap(region => regionData[region]);

            const { width, height } = getContainerSize('distribution-chart');
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };

            const svg = container
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .style('display', 'block')
                .style('width', '100%')
                .style('height', '100%')
                .style('max-width', '100%')
                .style('max-height', '100%');

            const xScale = d3.scaleBand()
                .domain(regions)
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);

            // 创建颜色比例尺
            const colorScale = d3.scaleOrdinal()
                .domain(regions)
                .range(colors.regions);

            // 绘制图表
            if (currentViewType === 'violin') {
                createViolinPlot(svg, regions, regionData, xScale, yScale, colorScale, margin);
            } else {
                createBoxPlot(svg, regions, regionData, xScale, yScale, colorScale, margin);
            }

            // 添加X轴
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .attr('text-anchor', 'end')
                .attr('font-size', '10px');

            // 添加Y轴
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'))
                .selectAll('text')
                .attr('font-size', '10px');

            // 添加Y轴标签
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 15)
                .attr('x', -height/2)
                .text(currentPopulationType === 'urban' ? 
                    'Urban Population Ratio (%)' : 
                    'Rural Population Ratio (%)');
        }

        // 创建盒须图
        function createBoxPlot(svg, regions, regionData, xScale, yScale, colorScale, margin) {
            regions.forEach(region => {
                const data = regionData[region].map(d => d.populationRatio);
                const x = xScale(region) + xScale.bandwidth() / 2;
                
                // 计算统计值
                const q1 = d3.quantile(data, 0.25);
                const median = d3.quantile(data, 0.5);
                const q3 = d3.quantile(data, 0.75);
                const min = d3.min(data);
                const max = d3.max(data);
                const iqr = q3 - q1;
                const lowerFence = Math.max(min, q1 - 1.5 * iqr);
                const upperFence = Math.min(max, q3 + 1.5 * iqr);

                // 绘制须线
                svg.append('line')
                    .attr('x1', x)
                    .attr('x2', x)
                    .attr('y1', yScale(lowerFence))
                    .attr('y2', yScale(upperFence))
                    .attr('stroke', colors.urban)
                    .attr('stroke-width', 2)
                    .style('cursor', 'pointer')
                    .on('click', function(event) {
                        toggleRegionHighlight(region);
                    });

                // 绘制箱体
                svg.append('rect')
                    .attr('x', x - xScale.bandwidth() * 0.3)
                    .attr('y', yScale(q3))
                    .attr('width', xScale.bandwidth() * 0.6)
                    .attr('height', yScale(q1) - yScale(q3))
                    .attr('fill', colors.urban)
                    .attr('opacity', 0.7)
                    .attr('stroke', colors.urban)
                    .attr('stroke-width', 1)
                    .style('cursor', 'pointer')
                    .on('click', function(event) {
                        toggleRegionHighlight(region);
                    });

                // 绘制中位数线
                svg.append('line')
                    .attr('x1', x - xScale.bandwidth() * 0.3)
                    .attr('x2', x + xScale.bandwidth() * 0.3)
                    .attr('y1', yScale(median))
                    .attr('y2', yScale(median))
                    .attr('stroke', 'black')
                    .attr('stroke-width', 2)
                    .style('cursor', 'pointer')
                    .on('click', function(event) {
                        toggleRegionHighlight(region);
                    });


                // 添加简单注释
                svg.append('text')
                    .attr('x', x)
                    .attr('y', yScale(median) - 15)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', 'black')
                    .attr('font-weight', 'bold')
                    .text(`${median.toFixed(0)}%`);

                svg.append('text')
                    .attr('x', x)
                    .attr('y', yScale(median) + 25)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '8px')
                    .attr('fill', 'black')
                    .attr('opacity', 0.8)
                    .text(`n=${data.length}`);
            });
        }

        // 创建小提琴图
        function createViolinPlot(svg, regions, regionData, xScale, yScale, colorScale, margin) {
            regions.forEach(region => {
                const data = regionData[region].map(d => d.populationRatio);
                const x = xScale(region) + xScale.bandwidth() / 2;
                
                // 检查数据是否有效
                if (data.length === 0 || data.some(d => isNaN(d))) {
                    return;
                }
                
                // 创建核密度估计
                const kde = kernelDensityEstimator(kernelEpanechnikov(3), d3.ticks(0, 100, 100));
                const density = kde(data);
                
                // 过滤掉无效的密度值
                const validDensity = density.filter(d => !isNaN(d[1]) && d[1] > 0);
                
                if (validDensity.length === 0) {
                    return;
                }
                
                // 创建小提琴形状的路径
                const width = xScale.bandwidth() * 0.4; // 小提琴的宽度
                const maxDensity = d3.max(validDensity, d => d[1]);
                
                // 创建左右两边的路径点
                const leftPoints = validDensity.map(d => `${x - (d[1] / maxDensity) * width},${yScale(d[0])}`);
                const rightPoints = validDensity.map(d => `${x + (d[1] / maxDensity) * width},${yScale(d[0])}`).reverse();
                
                // 合并路径点
                const allPoints = [...leftPoints, ...rightPoints];
                const path = `M${allPoints[0]}L${allPoints.slice(1).join('L')}Z`;
                
                // 绘制小提琴形状
                svg.append('path')
                    .attr('d', path)
                    .attr('fill', colors.urban)
                    .attr('opacity', 0.7)
                    .attr('stroke', colors.urban)
                    .attr('stroke-width', 1)
                    .style('cursor', 'pointer')
                    .on('click', function(event) {
                        toggleRegionHighlight(region);
                    });

                // 计算统计值
                const q1 = d3.quantile(data, 0.25);
                const median = d3.quantile(data, 0.5);
                const q3 = d3.quantile(data, 0.75);
                const min = d3.min(data);
                const max = d3.max(data);

                // 绘制中位数线
                svg.append('line')
                    .attr('x1', x - width)
                    .attr('x2', x + width)
                    .attr('y1', yScale(median))
                    .attr('y2', yScale(median))
                    .attr('stroke', 'black')
                    .attr('stroke-width', 2)
                    .style('cursor', 'pointer')
                    .on('click', function(event) {
                        toggleRegionHighlight(region);
                    });

                // 只保留中位数线，其他统计标记已简化

                // 添加简单注释
                svg.append('text')
                    .attr('x', x)
                    .attr('y', yScale(median) - 15)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', 'black')
                    .attr('font-weight', 'bold')
                    .text(`${median.toFixed(0)}%`);

                svg.append('text')
                    .attr('x', x)
                    .attr('y', yScale(median) + 25)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '8px')
                    .attr('fill', 'black')
                    .attr('opacity', 0.8)
                    .text(`n=${data.length}`);
            });
        }

        // 核密度估计器
        function kernelDensityEstimator(kernel, X) {
            return function(V) {
                return X.map(function(x) {
                    return [x, d3.mean(V, function(v) { return kernel(x - v); })];
                });
            };
        }

        // Epanechnikov核函数
        function kernelEpanechnikov(k) {
            return function(v) {
                return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
            };
        }

        // 更新分布图表
        function updateDistributionChart() {
            // 清除现有图表并重新创建
            const container = d3.select('#distribution-chart');
            container.selectAll('*').remove();
            
            // 准备数据 - 按区域分组城市化率
            const regionData = {};
            Object.entries(regionMapping).forEach(([region, countries]) => {
                regionData[region] = countries
                    .map(countryName => populationData.countries[countryName])
                    .filter(country => country && country.total > 0)
                    .map(country => ({
                        country: country.country,
                        populationRatio: currentPopulationType === 'urban' ? 
                            country.urban_share * 100 : 
                            country.rural_share * 100,
                        region: region
                    }));
            });

            const regions = Object.keys(regionData).filter(region => regionData[region].length > 0);
            const allData = regions.flatMap(region => regionData[region]);

            const { width, height } = getContainerSize('distribution-chart');
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };

            const svg = container
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .style('display', 'block')
                .style('width', '100%')
                .style('height', '100%')
                .style('max-width', '100%')
                .style('max-height', '100%');

            const xScale = d3.scaleBand()
                .domain(regions)
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);

            // 创建颜色比例尺
            const colorScale = d3.scaleOrdinal()
                .domain(regions)
                .range(colors.regions);

            // 绘制图表
            if (currentViewType === 'violin') {
                createViolinPlot(svg, regions, regionData, xScale, yScale, colorScale, margin);
            } else {
                createBoxPlot(svg, regions, regionData, xScale, yScale, colorScale, margin);
            }

            // 添加X轴
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .attr('text-anchor', 'end')
                .attr('font-size', '10px');

            // 添加Y轴
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'))
                .selectAll('text')
                .attr('font-size', '10px');

            // 添加Y轴标签
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 15)
                .attr('x', -height/2)
                .text(currentPopulationType === 'urban' ? 
                    'Urban Population Ratio (%)' : 
                    'Rural Population Ratio (%)');
        }

        // 创建国家列表
        function createCountryList() {
            const countries = Object.values(populationData.countries)
                .sort((a, b) => b.total - a.total);

            const list = d3.select('#country-list');
            list.selectAll('*').remove();

            const items = list.selectAll('.country-item')
                .data(countries)
                .enter()
                .append('div')
                .attr('class', 'country-item')
                .attr('data-country', d => d.country)
                .on('click', function(event, d) {
                    selectCountry(d.country);
                });

            items.append('div')
                .attr('class', 'country-name')
                .text(d => d.country);

            items.append('div')
                .attr('class', 'country-stats')
                .html(d => `
                    <div style="margin-bottom: 4px;">
                        <span>Total: ${formatNumber(d.total)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; gap: 10px;">
                        <span style="color: #589FBC;">Urban: ${formatNumber(d.urban)} (${Math.round(d.urban_share * 100)}%)</span>
                        <span style="color: #B4628E;">Rural: ${formatNumber(d.rural)} (${Math.round(d.rural_share * 100)}%)</span>
                    </div>
                `);
        }

        // 选择国家
        function selectCountry(countryName) {
            selectedCountry = countryName;
            
            // 清除区域高亮
            clearRegionHighlight();
            
            // 更新国家列表选中状态
            d3.selectAll('.country-item')
                .classed('selected', d => d.country === countryName);

            // 自动滚动到选中的国家
            scrollToSelectedCountry(countryName);

            // 高亮相关图表中的国家
            highlightCountry(countryName);
        }

        // 滚动到选中的国家
        function scrollToSelectedCountry(countryName) {
            const countryList = document.getElementById('country-list');
            const selectedItem = countryList.querySelector(`[data-country="${countryName}"]`);
            
            if (selectedItem) {
                // 计算滚动位置，让选中项居中显示
                const containerHeight = countryList.clientHeight;
                const itemTop = selectedItem.offsetTop;
                const itemHeight = selectedItem.offsetHeight;
                const scrollTop = itemTop - (containerHeight / 2) + (itemHeight / 2);
                
                // 平滑滚动
                countryList.scrollTo({
                    top: Math.max(0, scrollTop),
                    behavior: 'smooth'
                });
            }
        }

        // 高亮国家
        function highlightCountry(countryName) {
            // 在密度图中高亮
            d3.selectAll('.point')
                .classed('highlighted', d => d.country === countryName)
                .style('stroke', d => d.country === countryName ? colors.highlight : 'none')
                .style('stroke-width', d => d.country === countryName ? 2 : 0);
        }

        // 切换区域高亮
        function toggleRegionHighlight(regionName) {
            if (highlightedRegion === regionName) {
                // 如果点击的是当前高亮的区域，则取消高亮
                clearRegionHighlight();
                highlightedRegion = null;
            } else {
                // 高亮新区域
                highlightRegion(regionName);
                highlightedRegion = regionName;
            }
        }

        // 高亮区域
        function highlightRegion(regionName) {
            // 获取该区域的所有国家
            const regionCountries = regionMapping[regionName] || [];
            
            // 高亮地图上的国家
            d3.selectAll('.country-pie')
                .style('opacity', d => {
                    const countryName = d.properties.name;
                    return regionCountries.includes(countryName) ? 1 : 0.3;
                });

            // 高亮右侧国家列表
            d3.selectAll('.country-item')
                .classed('region-highlighted', d => regionCountries.includes(d.country))
                .style('opacity', d => regionCountries.includes(d.country) ? 1 : 0.3);

            // 高亮密度图中的点
            d3.selectAll('.point')
                .style('opacity', d => regionCountries.includes(d.country) ? 1 : 0.3)
                .style('stroke', d => regionCountries.includes(d.country) ? colors.highlight : 'none')
                .style('stroke-width', d => regionCountries.includes(d.country) ? 2 : 0);

            // 高亮城市化率图表中的柱状图
            d3.selectAll('.urbanization-bar')
                .style('opacity', d => regionCountries.includes(d.country) ? 1 : 0.3);

            // 高亮国家堆叠图中的柱状图
            d3.selectAll('.country-group rect')
                .style('opacity', d => regionCountries.includes(d.data.country) ? 1 : 0.3);
        }

        // 清除区域高亮
        function clearRegionHighlight() {
            // 清除高亮状态
            highlightedRegion = null;
            
            // 恢复地图透明度
            d3.selectAll('.country-pie')
                .style('opacity', 0.7);

            // 恢复国家列表透明度
            d3.selectAll('.country-item')
                .classed('region-highlighted', false)
                .style('opacity', 1);

            // 恢复密度图透明度
            d3.selectAll('.point')
                .style('opacity', 0.6)
                .style('stroke', 'none')
                .style('stroke-width', 0);

            // 恢复城市化率图表透明度
            d3.selectAll('.urbanization-bar')
                .style('opacity', 1);

            // 恢复国家堆叠图透明度
            d3.selectAll('.country-group rect')
                .style('opacity', 1);
        }


        // 显示工具提示
        function showTooltip(event, data, type) {
            const tooltip = d3.select('#tooltip');
            let content = '';

            if (type === 'density') {
                content = `
                    <strong>${data.country}</strong><br/>
                    Urban Density: ${formatNumber(data.urbanDensity)} people/km²<br/>
                    Rural Density: ${formatNumber(data.ruralDensity)} people/km²<br/>
                    Total Population: ${formatNumber(data.total)}<br/>
                    Urban Share: ${Math.round(data.urban / data.total * 100)}%<br/>
                    Rural Share: ${Math.round(data.rural / data.total * 100)}%
                `;
            } else if (type === 'map') {
                const percentage = Math.round(data[data.type.toLowerCase()] / data.total * 100);
                const value = currentViewType === 'percentage' ? 
                    `${percentage}%` : 
                    formatNumber(data[data.type.toLowerCase()]);
                
                content = `
                    <strong>${data.country}</strong><br/>
                    ${data.type}: ${value}<br/>
                    Total: ${formatNumber(data.total)}<br/>
                    Percentage: ${percentage}%
                `;
            } else if (type === 'urbanization') {
                content = `
                    <strong>${data.country}</strong><br/>
                    Urban Population Ratio: ${data.urbanizationRate.toFixed(1)}%<br/>
                    Urban Population: ${formatNumber(data.urban)}<br/>
                    Rural Population: ${formatNumber(data.rural)}<br/>
                    Total Population: ${formatNumber(data.total)}
                `;
            } else {
                const percentage = Math.round(data[type] / data.total * 100);
                const value = currentViewType === 'percentage' ? 
                    `${percentage}%` : 
                    formatNumber(data[type]);
                
                content = `
                    <strong>${data.country || data.region}</strong><br/>
                    ${type.charAt(0).toUpperCase() + type.slice(1)}: ${value}<br/>
                    Total: ${formatNumber(data.total)}<br/>
                    Percentage: ${percentage}%
                `;
            }

            tooltip.html(content)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .style('opacity', 1);
        }

        // 隐藏工具提示
        function hideTooltip() {
            d3.select('#tooltip').style('opacity', 0);
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 切换按钮 - 每个图表独立控制
            d3.selectAll('.toggle-btn').on('click', function() {
                const button = d3.select(this);
                const type = button.attr('data-type');
                const populationType = button.attr('data-population-type');
                const container = button.node().closest('.chart-container');
                const chartId = d3.select(container).select('svg').attr('id');
                
                // 更新按钮状态 - 只更新同一组的按钮
                if (populationType) {
                    // 人口类型按钮组
                    d3.select(container).selectAll('.toggle-btn[data-population-type]').classed('active', false);
                } else {
                    // 图表类型按钮组
                    d3.select(container).selectAll('.toggle-btn[data-type]').classed('active', false);
                }
                button.classed('active', true);
                
                // 如果是人口类型切换按钮
                if (populationType) {
                    currentPopulationType = populationType;
                    if (chartId === 'distribution-chart') {
                        createDistributionChart();
                    }
                } else {
                    // 根据图表ID更新对应的图表
                    updateSpecificChart(chartId, type);
                }
            });
        }

        // 更新特定图表
        function updateSpecificChart(chartId, viewType) {
            // 保存当前视图类型
            const previousViewType = currentViewType;
            currentViewType = viewType;
            
            // 根据图表ID更新对应的图表
            switch(chartId) {
                case 'pie-chart':
                    createOverallPieChart();
                    break;
                case 'regions-chart':
                    createRegionsStackedChart();
                    break;
                case 'stacked-chart':
                    createCountriesStackedChart();
                    break;
                case 'density-chart':
                    createDensityChart();
                    break;
                case 'country-map':
                    createCountryMap();
                    break;
                case 'urbanization-chart':
                    createUrbanizationChart();
                    break;
                case 'distribution-chart':
                    createDistributionChart();
                    break;
            }
        }

        // 格式化数字
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // 窗口大小变化时重新绘制
        window.addEventListener('resize', function() {
            if (populationData) {
                // 使用防抖来避免频繁重绘
                clearTimeout(window.resizeTimeout);
                window.resizeTimeout = setTimeout(() => {
                    createOverallPieChart();
                    createCountriesStackedChart();
                    createRegionsStackedChart();
                    createDensityChart();
                    createCountryMap();
                    createUrbanizationChart();
                    createDistributionChart();
                }, 200);
            }
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
